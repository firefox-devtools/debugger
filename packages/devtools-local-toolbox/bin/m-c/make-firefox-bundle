#!/bin/sh

if [ -z "$1" ]; then
   echo "Usage: $0 <path-to-firefox-repo>"
   exit 1
fi

if [ "$2" == "--symlink-mochitests" ]; then
  SYMLINK_MOCHITESTS=1
fi

ROOT=`dirname $0`
DEBUGGER_PATH="$1/devtools/client/debugger/new"
PROPERTIES_PATH="$1/devtools/client/locales/en-US/"
REV=`git log -1 --pretty=oneline`

if [ ! -d "$DEBUGGER_PATH" ]; then
   echo "Cannot find debugger at $DEBUGGER_PATH"
   exit 2
fi

(
    cd "$DEBUGGER_PATH";
    if [ -d "DEBUGGER_PATH/.git" ]; then
        if ! git log --oneline bundle.js | head -n 1 |
                grep "UPDATE_BUNDLE" > /dev/null; then
            echo "\033[31mWARNING\033[0m: bundle has changed on mozilla-central";
        fi
    fi
);

TARGET=firefox-panel node_modules/.bin/webpack

echo "// Generated from: $REV\n" | cat - assets/build/bundle.js > "$DEBUGGER_PATH/bundle.js"
cp assets/build/source-map-worker.js "$DEBUGGER_PATH"
cp assets/build/pretty-print-worker.js "$DEBUGGER_PATH"
cp assets/build/styles.css "$DEBUGGER_PATH"
cp assets/images/* "$DEBUGGER_PATH/images"
cp assets/locales/debugger.properties "$PROPERTIES_PATH"

rm -r "$DEBUGGER_PATH/test/mochitest"
if [ -n "$SYMLINK_MOCHITESTS" ]; then
    ln -s `pwd -P`"/$ROOT/../src/test/mochitest/" "$DEBUGGER_PATH/test/mochitest"
else
    rsync -avz src/test/mochitest/ "$DEBUGGER_PATH/test/mochitest"
fi

# Make sure a rebuild uses the new tests
touch "$DEBUGGER_PATH/test/mochitest/browser.ini"
